# Домашнее задание к занятию 6. «Troubleshooting»

## Задача 1

<details>
  <summary>Описание задачи</summary>

Перед выполнением задания ознакомьтесь с документацией по [администрированию MongoDB](https://docs.mongodb.com/manual/administration/).

Пользователь (разработчик) написал в канал поддержки, что у него уже 3 минуты происходит CRUD-операция в MongoDB и её 
нужно прервать. 

Вы как инженер поддержки решили произвести эту операцию:

- напишите список операций, которые вы будете производить для остановки запроса пользователя;
- предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB.
</details>

### Ответ

#### напишите список операций, которые вы будете производить для остановки запроса пользователя;

- Выполнить поиск запроса

```
db.currentOp({ "active" : true, "secs_running" : { "$gt" : 180 }})
```

- примерный ответ

```JSON
{
    "inprog" : [
        {
            //...
            "opid" : 29833,
            "secs_running" : NumberLong(436)
            //...
        }
    ]
}
```

- далее принудительно завершить выполнение запроса

```
db.killOp(29833)
```

#### предложите вариант решения проблемы с долгими (зависающими) запросами в MongoDB.

- попровать вызвать метод maxTimeMS()
- через профайлер выявить медленные запросы, построить их план используя explain и выполнить оптимизацию: добавить/удалить индексы, партицирование и т.д.

## Задача 2

<details>
  <summary>Описание задачи</summary>
Перед выполнением задания познакомьтесь с документацией по [Redis latency troobleshooting](https://redis.io/topics/latency).

Вы запустили инстанс Redis для использования совместно с сервисом, который использует механизм TTL. 
Причём отношение количества записанных key-value-значений к количеству истёкших значений есть величина постоянная и
увеличивается пропорционально количеству реплик сервиса. 

При масштабировании сервиса до N реплик вы увидели, что:

- сначала происходит рост отношения записанных значений к истекшим,
- Redis блокирует операции записи.

Как вы думаете, в чём может быть проблема?
</details>

### Ответ

#### Как вы думаете, в чём может быть проблема?

- Большое количество истекших значений: если отношение количества записанных значений к истекшим значительно увеличивается при масштабировании сервиса до N реплик, возможно, что Redis не успевает обрабатывать все истекшие значения вовремя. Это может привести к накоплению большого количества истекших значений увеличению задержки при их удалении. Redis заблокировался (ACTIVE_EXPIRE_CYCLE_LOOKUPS_PER_LOOP),чтобы вывести из DB удаленные ключи и снизить их количество.

- Сетевые проблемы: проблемы с сетью между сервисом и Redis могут вызывать задержки при выполнении операций. Можно попробовать проверить сетевое соединение, убедиться, что нет пакетной потери или задержек, и оптимизировать сетевую конфигурацию при необходимости.

## Задача 3

<details>
  <summary>Описание задачи</summary>
Вы подняли базу данных MySQL для использования в гис-системе. При росте количества записей в таблицах базы
пользователи начали жаловаться на ошибки вида:
```python
InterfaceError: (InterfaceError) 2013: Lost connection to MySQL server during query u'SELECT..... '
```

Как вы думаете, почему это начало происходить и как локализовать проблему?

Какие пути решения этой проблемы вы можете предложить?
</details>

### Ответ

#### Как вы думаете, почему это начало происходить и как локализовать проблему?

- Проблемы с сетью: потеря соединения может быть связана с проблемами в сети, такими как неполадки с маршрутизатором, перегрузка сети или низкое качество соединения.
- Недостаток ресурсов сервера: если база данных сталкивается с большой нагрузкой из-за роста количества записей, сервер MySQL может не иметь достаточных ресурсов для обработки всех запросов. Проверить показатели мониторинга утилизации CPU.
- Неправильная конфигурация MySQL: некоторые параметры конфигурации MySQL могут быть неправильно настроены, что может привести к потере соединения. Например, настройки max_connections и wait_timeout
- Длительные запросы: запросы выполняются слишком долго из-за большого объема данных или неэффективных индексов, это может привести к разрыву соединения. Для выявления таких запросов можно включить slow_query_log.

#### Какие пути решения этой проблемы вы можете предложить?

- просмотреть журналы ошибок MySQL (обычно находятся в файле error.log) для получения дополнительной информации причинах разрыва соединения.
- проверить настройки таймаута, что настройка wait_timeout и interactive_timeout адекватно настроены для текущей нагрузки. Если таймаут слишком маленький, соединение может быть закрыто из-за неактивности.
- оптимизировать запросы. Использовать индексы для ускорения выполнения запросов и избегать долгих операций, которые могут привести к потере соединения.

## Задача 4

<details>
  <summary>Описание задачи</summary>
Вы решили перевести гис-систему из задачи 3 на PostgreSQL, так как прочитали в документации, что эта СУБД работает с 
большим объёмом данных лучше, чем MySQL.

После запуска пользователи начали жаловаться, что СУБД время от времени становится недоступной. В dmesg вы видите, что:

`postmaster invoked oom-killer`

Как вы думаете, что происходит?

Как бы вы решили эту проблему?
</details>

### Ответ

#### Как вы думаете, что происходит?

Падение процесса БД по недостатку памяти

#### Как бы вы решили эту проблему?

- Включить мониторинг производительности PostgreSQL и ОС, чтобы отслеживать использование памяти и выявлять потенциальные проблемы. Также настроить журналирование PostgreSQL для получения подробных записей о событиях, связанных с памятью.
- Проверить и оптимизировать индексы, чтобы уменьшить нагрузку на память.
- Проверить конфигурационные параметры памяти в файле postgresql.conf. Убедитесь, что они настроены оптимально для системы и объема данных.